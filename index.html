<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>AFL Ball Position Tracker</title>
  <style>
    #canvas-container {
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100vh;
      position: relative;
      margin: 0;
      padding: 0;
      overflow: hidden;
    }
    #settings-container {
      position: absolute;
      top: 10px;
      left: 10px;
      z-index: 100;
      background-color: rgba(255, 255, 255, 0.9);
      padding: 15px;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.2);
      max-width: 320px;
      overflow-y: auto;
      max-height: 80vh;
    }
    input {
      width: 100%;
      padding: 8px;
      margin-bottom: 10px;
      border: 1px solid #ccc;
      border-radius: 4px;
      box-sizing: border-box;
    }
    button {
      background-color: #008037;
      color: white;
      border: none;
      padding: 10px 15px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 16px;
      transition: background-color 0.3s;
      width: 100%;
    }
    button:hover {
      background-color: #006028;
    }
    button:disabled {
      background-color: #cccccc;
      cursor: not-allowed;
    }
    html, body { 
      margin: 0; 
      padding: 0; 
      height: 100%; 
      overflow: hidden;
      font-family: Arial, sans-serif;
    }
    canvas { display: block; }
    
    /* File status styling */
    #file-status {
      background-color: #f8f8f8;
      padding: 8px;
      border-radius: 4px;
      border: 1px solid #ddd;
    }
    
    /* Instructions panel styling */
    #instructions {
      position: fixed;
      top: 10px;
      right: 10px;
      background-color: rgba(255, 255, 255, 0.9);
      padding: 15px;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.2);
      max-width: 300px;
      font-size: 14px;
      display: none;
      z-index: 100;
    }
    
    #help-button {
      position: absolute;
      top: 10px;
      right: 10px;
      z-index: 50;
      width: auto;
      padding: 8px 16px;
      background-color: #333;
    }
  </style>
  <!-- p5 core -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.6.0/p5.js"></script>
  
  <!-- AWS IoT SDK - first load the AWS SDK -->
  <script src="https://sdk.amazonaws.com/js/aws-sdk-2.852.0.min.js"></script>
  
  <!-- Then load the AWS IoT SDK -->
  <script src="https://cdn.jsdelivr.net/npm/aws-iot-device-sdk@2.2.12/browser/aws-iot-sdk-browser-bundle.min.js"></script>
</head>
<body>
  <div id="canvas-container"></div>
  
  <!-- Help button -->
  <button id="help-button" onclick="toggleInstructions()">Help</button>
  
  <!-- Instructions panel -->
  <div id="instructions">
    <h3>AFL Ball Tracker</h3>
    <p>This application visualizes ball position data from an AWS IoT MQTT topic.</p>
    
    <h4>Setup Instructions:</h4>
    <ol>
      <li>Upload all 3 required certificate files:
        <ul>
          <li>Device certificate (.pem.crt)</li>
          <li>Private key (.private.key)</li>
          <li>Root CA certificate (AmazonRootCA1.pem)</li>
        </ul>
      </li>
      <li>Enter the MQTT topic that publishes ball position data</li>
      <li>Click "Connect to AWS IoT" to start receiving position data</li>
    </ol>
    
    <p>Expected message format:</p>
    <pre style="background:#f1f1f1;padding:10px;border-radius:5px;font-size:12px;overflow:auto;">
{
  "T": 0,
  "X": 51,  // 0-102 range
  "Y": 32,  // 0-64 range
  "P": 1,   // Possession (optional)
  "Pa": 0,  // Pass indicator (optional)
  "G": 0    // Goal indicator (optional)
}
</pre>
    
    <button onclick="toggleInstructions()" style="margin-top:10px">Close</button>
  </div>
  
  <!-- AWS IoT MQTT wrapper script -->
  <script>
    // Wait for AWS SDK to be fully loaded
    document.addEventListener('DOMContentLoaded', function() {
      // Create global AWS IoT device SDK namespace
      window.AWSIoTMQTT = {
        connect: function(options) {
          try {
            console.log("Connecting to AWS IoT with options:", options);
            
            // Ensure AWS is defined
            if (typeof AWS === 'undefined') {
              console.error("AWS SDK not loaded");
              throw new Error("AWS SDK not loaded. Please check your internet connection and refresh the page.");
            }
            
            // Create a device using AWS IoT Device SDK
            const device = new window.awsIot.device(options);
            
            // Set up common event listeners
            const eventEmitter = {
              handlers: {},
              on: function(event, handler) {
                if (!this.handlers[event]) {
                  this.handlers[event] = [];
                }
                this.handlers[event].push(handler);
                return this;
              },
              emit: function(event, ...args) {
                if (this.handlers[event]) {
                  this.handlers[event].forEach(handler => handler(...args));
                }
              }
            };
            
            // Handle connection
            device.on('connect', function() {
              console.log("AWS IoT device connected");
              eventEmitter.emit('connect');
            });
            
            // Handle messages
            device.on('message', function(topic, payload) {
              console.log("Message received on topic:", topic);
              eventEmitter.emit('message', topic, payload);
            });
            
            // Handle errors
            device.on('error', function(error) {
              console.error("AWS IoT error:", error);
              eventEmitter.emit('error', error);
            });
            
            // Handle close
            device.on('close', function() {
              console.log("AWS IoT connection closed");
              eventEmitter.emit('close');
            });
            
            // Add methods to our hybrid device
            const hybridDevice = {
              isConnected: function() {
                return device.connected;
              },
              subscribe: function(topic) {
                console.log("Subscribing to topic:", topic);
                device.subscribe(topic);
              },
              unsubscribe: function(topic) {
                device.unsubscribe(topic);
              },
              publish: function(topic, message) {
                device.publish(topic, message);
              },
              disconnect: function() {
                device.end();
              },
              on: eventEmitter.on.bind(eventEmitter)
            };
            
            return hybridDevice;
          } catch (error) {
            console.error("Error creating AWS IoT device:", error);
            throw error;
          }
        }
      };
    });
    
    // Instructions panel toggle
    function toggleInstructions() {
      const instructions = document.getElementById('instructions');
      if (instructions.style.display === 'block') {
        instructions.style.display = 'none';
      } else {
        instructions.style.display = 'block';
      }
    }
    
    // Show instructions on first load
    window.onload = function() {
      // Check if AWS SDK is loaded
      if (typeof AWS === 'undefined') {
        alert("Warning: AWS SDK failed to load. This application may not work properly. Please check your internet connection and refresh the page.");
      }
      
      // Show the instructions panel after a short delay
      setTimeout(function() {
        document.getElementById('instructions').style.display = 'block';
      }, 1000);
    };
  </script>
  
  <!-- Main application code -->
  <script src="aws-iot-tracker.js"></script>
</body>
</html>